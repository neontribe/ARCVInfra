- name: Playbook to dump SQL db (Store/Service)
  hosts: myservers
  become: yes

  tasks:

    - name: Ensure sql dump dir
      file:
        path: /var/www/ARCVService/db-dumps
        state: directory

    - name: Get current release
      stat:
        path: /var/www/ARCVService/current_release
      register: sym

    - name: Set current release name as fact
      set_fact:
        current_release: "{{ sym.stat.lnk_source | basename }}"

    - name: SQL dump file name as fact
      set_fact:
        dump_file: "{{ current_release }}_{{ ansible_date_time.iso8601 }}.sql.enc"

    - name: Dump MySQL database and encrypt without writing to disk
      shell: >
        mysqldump \
          --single-transaction \
          --quick \
          --lock-tables=false \
          --databases {{ db_name }} \
          --host 127.0.0.1 \
          --user={{ db_user_name }} \
          --password={{ db_user_password }} \
          | \
          openssl aes-256-cbc -a -salt \
          -out "/var/www/ARCVService/db-dumps/{{ dump_file }}" \
          -pass pass:{{ db_crypt_password }}

    - name: Gzip the dump file
      archive:
        path: "/var/www/ARCVService/db-dumps/{{ dump_file }}"
        remove: true

    # This throws a memory error on live :(
#    - name: Get the dump
#      fetch:
#        src: "/var/www/ARCVService/db-dumps/{{ dump_file }}.gz"
#        dest: dbdumps

# openssl aes-256-cbc -d -a -in /path/to/your/encrypted_output_file -out /path/to/decrypted_output_file -pass pass:your_encryption_password
